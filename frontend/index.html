<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supercharger Route Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure the map container has a defined height */
        #map {
            height: 100vh;
            width: 100%;
        }

        .info-window-content {
            font-family: Arial, sans-serif;
        }

        .info-window-content h2 {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 5px 0;
        }

        .info-window-content p {
            margin: 0;
            font-size: 14px;
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col md:flex-row h-screen font-sans">

    <!-- Sidebar for Route Details -->
    <aside class="w-full md:w-1/3 lg:w-1/4 h-1/2 md:h-full overflow-y-auto bg-white shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">Route Details</h1>
        <div id="details-panel">
            <p id="loading-message" class="text-gray-600">Loading route information...</p>
        </div>
    </aside>

    <!-- Map Container -->
    <main class="w-full md:w-2/3 lg:w-3/4 h-1/2 md:h-full">
        <div id="map"></div>
    </main>

    <script>
        // --- CONFIGURATION ---
        // ##################################################################
        // # IMPORTANT: Replace with your Google Maps API Key               #
        // ##################################################################
        const GOOGLE_MAPS_API_KEY = "{{.APIKey}}"
        // The URL of your local Go API server
        const GO_API_URL = "http://localhost:8080"

        // --- DOM Elements ---
        const detailsPanel = document.getElementById( 'details-panel' )
        const loadingMessage = document.getElementById( 'loading-message' )

        // --- MAP INITIALIZATION & LOGIC ---
        let map

        // Make initMap a global function so the Maps API callback can find it
        window.initMap = async function () {
            // Import the new Advanced Marker library
            const { Map } = await google.maps.importLibrary( "maps" )
            const { AdvancedMarkerElement } = await google.maps.importLibrary( "marker" )

            // Get origin and destination from URL query parameters
            const urlParams = new URLSearchParams( window.location.search )
            const origin = urlParams.get( 'origin' )
            const destination = urlParams.get( 'destination' )

            if ( !origin || !destination ) {
                loadingMessage.innerHTML = `<p class="text-red-500 font-semibold">Error: 'origin' and 'destination' query parameters are required.</p>
                <p class="text-sm text-gray-500 mt-2">Example: ?origin=San+Francisco,CA&destination=Los+Angeles,CA</p>`
                return
            }

            // Create a default map centered on the US
            map = new Map( document.getElementById( "map" ), {
                center: { lat: 39.8283, lng: -98.5795 },
                zoom: 4,
                mapId: "ROUTE_MAP", // Required for Advanced Markers
                mapTypeControl: false,
                streetViewControl: false,
            } )

            // Fetch data from the Go API
            fetchRouteData( AdvancedMarkerElement )
        }

        async function fetchRouteData ( AdvancedMarkerElement ) {
            const urlParams = new URLSearchParams( window.location.search )
            const origin = urlParams.get( 'origin' )
            const destination = urlParams.get( 'destination' )
            try {
                const response = await fetch( `${ GO_API_URL }/route?origin=${ encodeURIComponent( origin ) }&destination=${ encodeURIComponent( destination ) }` )
                if ( !response.ok ) {
                    throw new Error( `API responded with status: ${ response.status }` )
                }
                const data = await response.json()
                loadingMessage.style.display = 'none'

                // Process and display the data
                displayRouteOnMap( data.steps )
                displaySuperchargers( data.superchargers, AdvancedMarkerElement )
                displayDebugInfo( data.debug_info )
                displayDetailsInPanel( data )

            } catch ( error ) {
                loadingMessage.innerText = `Error fetching route data: ${ error.message }. Make sure your Go API server is running.`
                console.error( "Error fetching route data:", error )
            }
        }

        function displayRouteOnMap ( steps ) {
            const bounds = new google.maps.LatLngBounds()
            steps.forEach( step => {
                const decodedPath = google.maps.geometry.encoding.decodePath( step.polyline )
                const ratio = step.duration_in_traffic / step.duration
                let color = '#4285F4' // blue for no traffic
                if ( ratio > 1.5 ) {
                    color = '#FF0000' // red for heavy traffic
                } else if ( ratio > 1.2 ) {
                    color = '#FFFF00' // yellow for moderate traffic
                }
                const polyline = new google.maps.Polyline( {
                    path: decodedPath,
                    geodesic: true,
                    strokeColor: color,
                    strokeOpacity: 0.8,
                    strokeWeight: 6,
                } )
                polyline.setMap( map )
                decodedPath.forEach( point => bounds.extend( point ) )
            } )
            map.fitBounds( bounds )
        } function displaySuperchargers ( superchargers, AdvancedMarkerElement ) {
            const infoWindow = new google.maps.InfoWindow()

            superchargers.forEach( sc => {
                // Create marker for the supercharger
                const marker = new AdvancedMarkerElement( {
                    position: { lat: sc.lat, lng: sc.lng },
                    map: map,
                    title: sc.name,
                } )

                const contentString = `
                    <div class="info-window-content">
                        <h2>${ sc.name }</h2>
                        <p>${ sc.address }</p>
                        <p><strong>Arrival:</strong> ${ sc.arrival_time }</p>
                        <p><strong>Distance along route:</strong> ${ Math.round( sc.distance_meters / 1000 ) } km</p>
                        <p><strong>Distance from route:</strong> ${ sc.distance_from_route_meters } m</p>
                    </div>`

                marker.addListener( "click", () => {
                    infoWindow.setContent( contentString )
                    infoWindow.open( { anchor: marker, map } )
                } )

                // Draw line from supercharger to closest point on route
                if ( sc.closest_point_on_route ) {
                    const line = new google.maps.Polyline( {
                        path: [
                            { lat: sc.lat, lng: sc.lng },
                            { lat: sc.closest_point_on_route.lat, lng: sc.closest_point_on_route.lng }
                        ],
                        geodesic: true,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.6,
                        strokeWeight: 2,
                        map: map
                    } )
                }

                // Create markers for associated restaurants
                if ( sc.restaurants ) {
                    sc.restaurants.forEach( resto => {
                        const restaurantMarker = new AdvancedMarkerElement( {
                            position: { lat: resto.lat, lng: resto.lng },
                            map: map,
                            title: `${ resto.name } (${ resto.cuisine_types.join( ', ' ) || 'Restaurant' })`,
                        } )
                        // Create a custom icon element for restaurants
                        const icon = document.createElement( 'img' )
                        icon.src = "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                        restaurantMarker.content = icon
                    } )
                }
            } )
        }

        function displayDebugInfo ( debugInfo ) {
            debugInfo.api_calls.forEach( call => {
                if ( call.search_area ) {
                    // Draw a circle for each search radius
                    new google.maps.Circle( {
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.3,
                        strokeWeight: 1,
                        fillColor: '#FF0000',
                        fillOpacity: 0.05,
                        map: map,
                        center: { lat: call.search_area.center_lat, lng: call.search_area.center_lng },
                        radius: call.search_area.radius_m,
                    } )
                }
            } )
        }

        function displayDetailsInPanel ( data ) {
            let content = `
                <div class="mb-6 pb-4 border-b">
                    <h2 class="text-xl font-semibold text-gray-700">${ data.route.total_distance }</h2>
                    <p class="text-lg text-gray-600">${ data.route.total_duration }</p>
                </div>
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Supercharger Stops</h2>
            `

            if ( data.superchargers.length === 0 ) {
                content += '<p class="text-gray-500">No superchargers found on this route.</p>'
            }

            data.superchargers.forEach( sc => {
                content += `
                    <div class="mb-5 p-4 bg-gray-50 rounded-lg shadow-sm">
                        <h3 class="font-bold text-lg text-red-600">${ sc.name }</h3>
                        <p class="text-sm text-gray-600">${ sc.address }</p>
                        <p class="text-sm text-gray-600"><strong>Arrival:</strong> ${ sc.arrival_time }</p>
                        <p class="text-sm text-gray-600"><strong>Distance along route:</strong> ${ Math.round( sc.distance_meters / 1000 ) } km</p>
                        
                        <h4 class="font-semibold mt-3 mb-2 text-gray-700">Nearby Restaurants:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                `

                if ( sc.restaurants.length === 0 ) {
                    content += '<li class="text-gray-500">No restaurants found nearby.</li>'
                }

                sc.restaurants.forEach( resto => {
                    const cuisine = resto.cuisine_types.length > 0 ? `(${ resto.cuisine_types.join( ', ' ) })` : ''
                    content += `
                        <li class="text-gray-600">
                            ${ resto.name } ${ cuisine } - ${ resto.walking_distance_meters } m walk
                        </li>`
                } )

                content += `</ul></div>`
            } )

            detailsPanel.innerHTML = content
        }

        // --- DYNAMIC SCRIPT LOADING ---
        // This function dynamically creates and injects the Google Maps script tag.
        // This is the correct way to use a JavaScript variable (like GOOGLE_MAPS_API_KEY) in the script URL.
        function loadGoogleMapsScript () {
            const script = document.createElement( 'script' )
            script.src = `https://maps.googleapis.com/maps/api/js?key=${ GOOGLE_MAPS_API_KEY }&libraries=geometry&callback=initMap`
            script.async = true
            document.head.appendChild( script )
        }

        loadGoogleMapsScript();

    </script>
</body>

</html>